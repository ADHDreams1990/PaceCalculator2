<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pace Calculator 2 - Enhanced</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        :root {
            --primary-color: rgb(255, 98, 0);
            --primary-dark: rgb(200, 70, 0);
            --section-bg: #ffffff;
            --text-color: #333333;
            --font-size: 16px;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f4f4f4;
            color: var(--text-color);
            transition: all 0.3s ease;
            font-size: var(--font-size);
        }

        body.dark-mode {
            background-color: #1a1a1a;
            color: #f4f4f4;
            --section-bg: #2d2d2d;
            --text-color: #f4f4f4;
        }

        /* Theme Colors */
        body.theme-blue { --primary-color: rgb(0, 100, 255); --primary-dark: rgb(0, 70, 200); }
        body.theme-purple { --primary-color: rgb(150, 0, 255); --primary-dark: rgb(120, 0, 200); }
        body.theme-green { --primary-color: rgb(0, 150, 50); --primary-dark: rgb(0, 120, 40); }
        body.theme-red { --primary-color: rgb(220, 0, 0); --primary-dark: rgb(180, 0, 0); }
        body.theme-teal { --primary-color: rgb(0, 150, 150); --primary-dark: rgb(0, 120, 120); }
        body.theme-pink { --primary-color: rgb(255, 100, 180); --primary-dark: rgb(220, 70, 150); }
        body.theme-yellow { --primary-color: rgb(200, 160, 0); --primary-dark: rgb(160, 130, 0); }
        body.theme-amazon { 
            --primary-color: #007eb9;
            --primary-dark: #0066a1;
            --section-bg: #232f3e;
            --text-color: #ffffff;
            background-color: #111111;
        }
        
        body.theme-amazon:not(.dark-mode) {
            --section-bg: #ffffff;
            --text-color: #333333;
            background-color: #f4f4f4;
        }

        .container { max-width: 800px; margin: 0 auto; }
        
        section { 
            background: var(--section-bg); 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }

        header { 
            display: flex; 
            flex-direction: column;
            margin-bottom: 20px; 
            gap: 15px;
        }
        
        h1 { margin: 0; color: var(--primary-color); width: 100%; }

        .controls { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        
        .control-group { display: flex; align-items: center; gap: 8px; }

        .input-group { margin-bottom: 15px; position: relative; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        input[type="number"], input[type="time"], select { 
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; 
            font-size: 1em; background-color: var(--section-bg); color: var(--text-color);
        }
        
        .help-text { font-size: 0.8em; color: #666; margin-top: 3px; }

        button {
            background-color: var(--primary-color);
            border: none; color: white; padding: 10px 20px; text-align: center;
            text-decoration: none; display: inline-block; font-size: 1em;
            margin: 4px 2px; cursor: pointer; border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        button:hover { background-color: var(--primary-dark); }

        #resultsSection { 
            display: none; margin-top: 30px; border-top: 2px solid var(--primary-color); 
            padding-top: 20px; 
        }
        
        .result-group { 
            margin-bottom: 15px; padding: 15px;
            background: rgba(255, 98, 0, 0.1); border-radius: 5px;
            border-left: 3px solid var(--primary-color);
        }

        .result-value { font-weight: bold; font-size: 1.1em; color: var(--primary-color); }

        .dark-mode-toggle { 
            cursor: pointer; padding: 8px 12px; border-radius: 20px; 
            background: #ddd; transition: all 0.3s ease; font-size: 1.2em;
        }
        
        body.dark-mode .dark-mode-toggle { background: #555; }

        .input-group-logical {
            margin-bottom: 20px; padding: 15px;
            background: rgba(255, 98, 0, 0.05); border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }
        
        .input-group-logical h3 { margin-top: 0; color: var(--primary-color); font-size: 1.1em; }
        
        .input-row { display: flex; gap: 15px; margin-bottom: 10px; }
        
        .input-row .input-group { flex: 1; margin-bottom: 0; }

        .status-indicator { padding: 10px; border-radius: 5px; font-weight: bold; margin: 10px 0; }
        
        .status-low { background-color: #4CAF50; color: white; }
        .status-medium { background-color: #FF9800; color: white; }
        .status-high { background-color: #f44336; color: white; }
        
        .breaks-row { display: flex; gap: 15px; margin-bottom: 15px; }
        
        .break-group { flex: 1; }
        
        .break-group label { font-size: 0.9em; }
        
        .break-group input { font-size: 0.9em; padding: 6px; }
        
        .parenthesis { font-weight: normal; opacity: 0.8; }
        
        .disclaimer {
            font-size: 0.75em; color: #666; text-align: center; margin-top: 25px;
            padding: 15px; background: rgba(255, 98, 0, 0.05); border-radius: 8px;
            border: 1px dashed rgba(255, 98, 0, 0.3); font-style: italic;
        }
        
        .rescue-fields {
            margin-top: 15px; padding: 15px;
            background: rgba(255, 98, 0, 0.05); border-radius: 5px;
            border-left: 3px solid var(--primary-color);
        }
        
        .comparison-group {
            margin-top: 20px; padding: 15px;
            background: rgba(0, 100, 255, 0.1); border-radius: 5px;
            border-left: 3px solid #0064ff;
        }
        
        .comparison-value { font-weight: bold; font-size: 1.1em; color: #0064ff; }
        
        .controls-row { display: flex; flex-direction: column; gap: 10px; }
        
        .controls-main { display: flex; gap: 15px; flex-wrap: wrap; }
        
        .controls-secondary { display: flex; gap: 15px; flex-wrap: wrap; margin-left: 0; }
        
        .rescue-result-group {
            margin-bottom: 15px; padding: 15px;
            background: rgba(150, 0, 255, 0.1); border-radius: 5px;
            border-left: 3px solid #9600ff;
        }
        
        .rescue-value { font-weight: bold; font-size: 1.1em; color: #9600ff; }
        
        .amazon-warning {
            background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404;
            padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.9em;
        }
        
        .reset-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        
        .reset-fields-button { background-color: #ff6b6b; font-size: 0.8em; padding: 5px 10px; }
        
        .reset-fields-button:hover { background-color: #ff5252; }
        
        .reset-settings-button { background-color: #666; font-size: 0.8em; padding: 5px 10px; }
        
        .reset-settings-button:hover { background-color: #444; }
        
        @media (min-width: 768px) {
            header { flex-direction: row; justify-content: space-between; align-items: center; }
            .controls { width: auto; max-width: 500px; }
        }
        
        .loading {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,.3); border-radius: 50%;
            border-top-color: #fff; animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .completed-route-indicator {
            background-color: #4CAF50; color: white; padding: 10px;
            border-radius: 5px; margin: 10px 0; font-weight: bold; text-align: center;
        }
        
        .amazon-combined {
            display: flex; justify-content: flex-start; align-items: center;
            margin: 10px 0; gap: 8px; flex-wrap: wrap;
        }
        
        .amazon-combined-value { font-weight: bold; font-size: 1.1em; color: #0064ff; margin-left: 5px; }
        
        .vs-amazon-container {
            display: flex; align-items: center; gap: 8px;
            margin-top: 8px; flex-wrap: wrap;
        }
        
        /* NEW: Auto-update time controls */
        .time-control-group { display: flex; align-items: center; gap: 10px; }
        
        .time-control-group input[type="time"] { flex: 1; }
        
        .auto-update-checkbox { display: flex; align-items: center; gap: 5px; font-size: 0.9em; white-space: nowrap; }
        
        .auto-update-checkbox input { margin: 0; }
        
        .update-now-button { background-color: #4CAF50; font-size: 0.8em; padding: 5px 10px; white-space: nowrap; }
        
        .update-now-button:hover { background-color: #45a049; }
        
        .auto-clear-checkbox { display: flex; align-items: center; gap: 5px; font-size: 0.9em; margin-top: 5px; }
        
        .auto-clear-checkbox input { margin: 0; }
        
        .saved-indicator { color: #4CAF50; font-size: 0.8em; margin-left: 10px; opacity: 0; transition: opacity 0.3s; }
        
        .saved-indicator.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="main-title">Pace Calculator 2</h1>
            <div class="controls">
                <div class="controls-row">
                    <div class="controls-main">
                        <div class="control-group">
                            <label for="languageSelector">Idioma/Language:</label>
                            <select id="languageSelector">
                                <option value="en">English</option>
                                <option value="es">Espa√±ol</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="themeSelector">Color Theme:</label>
                            <select id="themeSelector">
                                <option value="default">Default Orange</option>
                                <option value="blue">Blue</option>
                                <option value="purple">Purple</option>
                                <option value="green">Green</option>
                                <option value="red">Red</option>
                                <option value="teal">Teal</option>
                                <option value="pink">Pink</option>
                                <option value="yellow">Yellow</option>
                                <option value="amazon">Amazon</option>
                            </select>
                        </div>
                    </div>
                    <div class="controls-secondary">
                        <div class="control-group">
                            <label for="fontSizeSlider">Font Size:</label>
                            <input type="range" id="fontSizeSlider" min="12" max="24" value="16" step="1">
                        </div>
                        <div class="control-group">
                            <span class="dark-mode-toggle" id="darkModeToggle">üåô</span>
                        </div>
                    </div>
                </div>
                <div class="reset-buttons">
                    <button class="reset-fields-button" id="resetFields">Reset All Fields</button>
                    <button class="reset-settings-button" id="resetSettings">Reset All Settings</button>
                    <div class="auto-clear-checkbox">
                        <input type="checkbox" id="autoClearAtMidnight">
                        <label for="autoClearAtMidnight">Auto-clear at midnight</label>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <section id="routeDataSection">
                <h2 id="route-data-title">Your Route Data</h2>
                
                <div class="input-group">
                    <label for="firstPackageTime" id="first-package-label">First Package Delivered Time</label>
                    <input type="time" id="firstPackageTime" required value="10:00">
                </div>
                <div class="input-group">
                    <label for="currentTime" id="current-time-label">
                        <span id="current-time-text">Current Time</span> 
                        <span class="parenthesis" id="current-time-parenthesis">(Or Time Ended)</span>
                    </label>
                    <div class="time-control-group">
                        <input type="time" id="currentTime" required>
                        <button class="update-now-button" id="updateNowButton">Update to Now</button>
                    </div>
                    <div class="auto-update-checkbox">
                        <input type="checkbox" id="autoUpdateTime" checked>
                        <label for="autoUpdateTime">Auto-update current time</label>
                        <span class="saved-indicator" id="timeSavedIndicator">‚úì Saved</span>
                    </div>
                    <div class="help-text" id="current-time-help">Use current time if still working, or end time if route is completed</div>
                </div>

                <div class="input-group-logical">
                    <h3 id="completed-group-title">Completed Stops</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="completedStops" id="completed-stops-label">Total Completed</label>
                            <input type="number" id="completedStops" min="0" placeholder="Enter number">
                        </div>
                        <div class="input-group">
                            <label for="completedAptStops" id="completed-apt-label">Apartment Stops Completed</label>
                            <input type="number" id="completedAptStops" min="0" placeholder="Enter number">
                        </div>
                    </div>
                </div>

                <div class="input-group-logical">
                    <h3 id="total-group-title">Total Stops for Today</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="totalStops" id="total-stops-label">Total Stop Count</label>
                            <input type="number" id="totalStops" min="1" placeholder="Enter number">
                        </div>
                        <div class="input-group">
                            <label for="totalAptStops" id="total-apt-label">Total Apt Stops</label>
                            <input type="number" id="totalAptStops" min="0" placeholder="Enter number">
                        </div>
                    </div>
                </div>
            </section>

            <section id="breaksSection">
                <h2 id="breaks-title">Breaks (Optional)</h2>
                <div class="breaks-row">
                    <div class="break-group">
                        <label for="firstBreak" id="first-break-label">1st Break (minutes):</label>
                        <input type="number" id="firstBreak" min="0" placeholder="Optional">
                    </div>
                    <div class="break-group">
                        <label for="lunchBreak" id="lunch-break-label">Lunch (minutes):</label>
                        <input type="number" id="lunchBreak" min="0" placeholder="Optional">
                    </div>
                    <div class="break-group">
                        <label for="secondBreak" id="second-break-label">2nd Break (minutes):</label>
                        <input type="number" id="secondBreak" min="0" placeholder="Optional">
                    </div>
                </div>
                <div class="help-text" id="breaks-help">Leave blank if no breaks were taken</div>
            </section>

            <section id="amazonSection">
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="compareAmazonCheckbox">
                        <span id="amazon-checkbox-label">Compare with Amazon's Forecast</span>
                    </label>
                </div>
                <div id="amazonFields" style="display: none;">
                    <div class="input-group">
                        <label for="amazonEndTime" id="amazon-end-label">Amazon's Expected End Time</label>
                        <input type="time" id="amazonEndTime" value="17:00">
                    </div>
                </div>
            </section>

            <section id="rescueSection">
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="hadRescueCheckbox">
                        <span id="rescue-checkbox-label">I had a rescue today</span>
                    </label>
                </div>
                <div id="rescueFields" class="rescue-fields" style="display: none;">
                    <div class="input-row">
                        <div class="input-group">
                            <label for="rescueTravelTime" id="rescue-travel-label">Time traveled to first rescue delivery (minutes)</label>
                            <input type="number" id="rescueTravelTime" min="0" placeholder="Optional">
                        </div>
                        <div class="input-group">
                            <label for="rescueStopsAdded" id="rescue-stops-label">Number of stops added from rescue</label>
                            <input type="number" id="rescueStopsAdded" min="0" placeholder="Optional">
                        </div>
                    </div>
                    <div class="help-text" id="rescue-help">Rescue stops will be calculated separately and won't affect your main route pace</div>
                </div>
            </section>

            <button type="button" id="calculateButton" style="width: 100%; padding: 15px; font-size: 1.2em; margin-top: 20px;">Calculate Pace</button>

            <section id="resultsSection">
                <h2 id="results-title">Results</h2>
                <div id="resultsContent"></div>
                <div class="disclaimer" id="disclaimer-text">
                    Note: These calculations are based on general formulas and are not Amazon's official algorithms. Results are approximate and for informational purposes only.
                </div>
            </section>
        </main>
    </div>

    <script>
        // Translations
        const translations = {
            en: {
                "main-title": "Pace Calculator 2",
                "route-data-title": "Your Route Data",
                "breaks-title": "Breaks (Optional)",
                "results-title": "Results",
                "first-package-label": "First Package Delivered Time",
                "current-time-text": "Current Time",
                "current-time-parenthesis": "(Or Time Ended)",
                "current-time-help": "Use current time if still working, or end time if route is completed",
                "completed-group-title": "Completed Stops",
                "total-group-title": "Total Stops for Today",
                "completed-stops-label": "Total Completed",
                "completed-apt-label": "Apartment Stops Completed",
                "total-stops-label": "Total Stop Count",
                "total-apt-label": "Total Apt Stops",
                "rescue-checkbox-label": "I had a rescue today",
                "rescue-travel-label": "Time traveled to first rescue delivery (minutes)",
                "rescue-stops-label": "Number of stops added from rescue",
                "rescue-help": "Rescue stops will be calculated separately and won't affect your main route pace",
                "first-break-label": "1st Break (minutes):",
                "lunch-break-label": "Lunch (minutes):",
                "second-break-label": "2nd Break (minutes):",
                "breaks-help": "Leave blank if no breaks were taken",
                "amazon-checkbox-label": "Compare with Amazon's Forecast",
                "amazon-end-label": "Amazon's Expected End Time",
                "calculate-button": "Calculate Pace",
                "full-route": "Your Route Projection",
                "rescue-impact": "Rescue Impact",
                "amazon-comparison": "Amazon's Expectations",
                "current-pace": "Current Pace (Working Time Only)",
                "projected-finish": "Projected Finish (With Breaks)",
                "actual-finish": "Actual Finish Time",
                "rescue-projected-finish": "Rescue Projected Finish",
                "stops-hour": "stops/hour",
                "disclaimer-text": "Note: These calculations are based on general formulas and are not Amazon's official algorithms. Results are approximate and for informational purposes only.",
                "amazon-base": "Amazon's Base Expectation (Without Breaks)",
                "amazon-with-breaks": "Amazon's Expectation (With Breaks)",
                "amazon-pace": "Amazon's Expected Pace",
                "time-ahead": "ahead",
                "time-behind": "behind",
                "vs-amazon": "vs. Amazon's Expectations (With Breaks)",
                "rescue-total-time": "Rescue Total Time",
                "rescue-pace": "Rescue Pace",
                "minutes": "minutes",
                "rescue-stops-added": "Rescue Stops Added",
                "rescue-travel-time": "Rescue Travel Time",
                "amazon-time-required": "Amazon's expected end time is required for comparison",
                "status-need-speed": "Need to speed up",
                "status-a-little-behind": "A few minutes behind",
                "status-ahead": "Ahead of schedule",
                "status-on-track": "On schedule",
                "route-completed": "Route Completed!",
                "finished-ahead": "Finished ahead of schedule",
                "total-breaks": "Total Breaks",
                "amazon-working-pace": "Amazon's Expected Working Pace",
                "your-working-pace": "Your Working Pace",
                "update-now-button": "Update to Now",
                "auto-update-label": "Auto-update current time",
                "auto-clear-label": "Auto-clear at midnight"
            },
            es: {
                "main-title": "Calculadora de Ritmo 2.0",
                "route-data-title": "Datos de Tu Ruta",
                "breaks-title": "Descansos (Opcional)",
                "results-title": "Resultados",
                "first-package-label": "Hora de Primera Entrega",
                "current-time-text": "Hora Actual",
                "current-time-parenthesis": "(O Hora de Finalizaci√≥n)",
                "current-time-help": "Usa la hora actual si a√∫n est√°s trabajando, o la hora de finalizaci√≥n si la ruta est√° completada",
                "completed-group-title": "Paradas Completadas",
                "total-group-title": "Total de Paradas para Hoy",
                "completed-stops-label": "Total Completadas",
                "completed-apt-label": "Paradas en Aptos. Completadas",
                "total-stops-label": "Total de Paradas",
                "total-apt-label": "Total Paradas en Aptos.",
                "rescue-checkbox-label": "Tuve un rescate hoy",
                "rescue-travel-label": "Tiempo de viaje a primer rescate entregado (minutos)",
                "rescue-stops-label": "N√∫mero de paradas a√±adidas por rescate",
                "rescue-help": "Las paradas de rescate se calcular√°n por separado y no afectar√°n tu ritmo de ruta principal",
                "first-break-label": "1er Descanso (minutos):",
                "lunch-break-label": "Almuerzo (minutos):",
                "second-break-label": "2do Descanso (minutos):",
                "breaks-help": "Dejar en blanco si no se tomaron descansos",
                "amazon-checkbox-label": "Comparar con Pron√≥stico de Amazon",
                "amazon-end-label": "Hora Final Esperada por Amazon",
                "calculate-button": "Calcular Ritmo",
                "full-route": "Tu Proyecci√≥n de Ruta",
                "rescue-impact": "Impacto del Rescate",
                "amazon-comparison": "Expectativas de Amazon",
                "current-pace": "Ritmo Actual (Solo Tiempo de Trabajo)",
                "projected-finish": "Final Proyectado (Con Descansos)",
                "actual-finish": "Hora de Finalizaci√≥n Real",
                "rescue-projected-finish": "Final Proyectado del Rescate",
                "stops-hour": "paradas/hora",
                "disclaimer-text": "Nota: Estos c√°lculos se basan en f√≥rmulas generales y no son los algoritmos oficiales de Amazon. Los resultados son aproximados y solo para fines informativos.",
                "amazon-base": "Expectativa Base de Amazon (Sin Descansos)",
                "amazon-with-breaks": "Expectativa de Amazon (Con Descansos)",
                "amazon-pace": "Ritmo Esperado por Amazon",
                "time-ahead": "adelantado",
                "time-behind": "atrasado",
                "vs-amazon": "vs. Expectativas de Amazon (Con Descansos)",
                "rescue-total-time": "Tiempo Total del Rescate",
                "rescue-pace": "Ritmo del Rescate",
                "minutes": "minutos",
                "rescue-stops-added": "Paradas de Rescate A√±adidas",
                "rescue-travel-time": "Tiempo de Viaje al Rescate",
                "amazon-time-required": "Se requiere la hora final esperada por Amazon para la comparaci√≥n",
                "status-need-speed": "Necesitas acelerar",
                "status-a-little-behind": "Un poco atrasado",
                "status-ahead": "Adelantado",
                "status-on-track": "En el horario",
                "route-completed": "¬°Ruta Completada!",
                "finished-ahead": "Terminado antes del horario",
                "total-breaks": "Total de Descansos",
                "amazon-working-pace": "Ritmo de Trabajo Esperado por Amazon",
                "your-working-pace": "Tu Ritmo de Trabajo",
                "update-now-button": "Actualizar a Ahora",
                "auto-update-label": "Actualizar hora actual autom√°ticamente",
                "auto-clear-label": "Limpiar autom√°ticamente a medianoche"
            }
        };

        // Utility Functions
        function timeStringToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesTo12hTimeString(totalMinutes) {
            const normalizedMinutes = totalMinutes % (24 * 60);
            const hours = Math.floor(normalizedMinutes / 60);
            const minutes = Math.floor(normalizedMinutes % 60);
            const period = hours >= 12 ? 'PM' : 'AM';
            let twelveHour = hours % 12;
            if (twelveHour === 0) twelveHour = 12;
            return `${twelveHour}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        function time24hTo12h(time24h) {
            if (!time24h) return "";
            const [hours, minutes] = time24h.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            let twelveHour = hours % 12;
            if (twelveHour === 0) twelveHour = 12;
            return `${twelveHour}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        function getCurrentTimeString() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        function setLanguage(lang) {
            Object.keys(translations[lang]).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = translations[lang][key];
                }
            });
            document.getElementById('calculateButton').textContent = translations[lang]['calculate-button'];
            document.getElementById('breaks-help').textContent = translations[lang]['breaks-help'];
            document.getElementById('updateNowButton').textContent = translations[lang]['update-now-button'];
            document.querySelector('label[for="autoUpdateTime"]').textContent = translations[lang]['auto-update-label'];
            document.querySelector('label[for="autoClearAtMidnight"]').textContent = translations[lang]['auto-clear-label'];
        }

        // NEW: Function to save all form data
        function saveFormData() {
            const formData = {
                firstPackageTime: document.getElementById('firstPackageTime').value,
                currentTime: document.getElementById('currentTime').value,
                completedStops: document.getElementById('completedStops').value,
                completedAptStops: document.getElementById('completedAptStops').value,
                totalStops: document.getElementById('totalStops').value,
                totalAptStops: document.getElementById('totalAptStops').value,
                firstBreak: document.getElementById('firstBreak').value,
                lunchBreak: document.getElementById('lunchBreak').value,
                secondBreak: document.getElementById('secondBreak').value,
                compareAmazon: document.getElementById('compareAmazonCheckbox').checked,
                amazonEndTime: document.getElementById('amazonEndTime').value,
                hadRescue: document.getElementById('hadRescueCheckbox').checked,
                rescueTravelTime: document.getElementById('rescueTravelTime').value,
                rescueStopsAdded: document.getElementById('rescueStopsAdded').value,
                autoUpdateTime: document.getElementById('autoUpdateTime').checked,
                autoClearAtMidnight: document.getElementById('autoClearAtMidnight').checked,
                lastSaveDate: new Date().toDateString()
            };
            
            localStorage.setItem('paceCalculatorFormData', JSON.stringify(formData));
            
            // Show saved indicator
            const indicator = document.getElementById('timeSavedIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // NEW: Function to load all form data
        function loadFormData() {
            const savedData = localStorage.getItem('paceCalculatorFormData');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    
                    // Check if we should auto-clear (if it's a new day and auto-clear is enabled)
                    const today = new Date().toDateString();
                    if (formData.autoClearAtMidnight && formData.lastSaveDate !== today) {
                        return;
                    }
                    
                    // Load all form values
                    document.getElementById('firstPackageTime').value = formData.firstPackageTime || '10:00';
                    document.getElementById('currentTime').value = formData.currentTime || getCurrentTimeString();
                    document.getElementById('completedStops').value = formData.completedStops || '';
                    document.getElementById('completedAptStops').value = formData.completedAptStops || '';
                    document.getElementById('totalStops').value = formData.totalStops || '';
                    document.getElementById('totalAptStops').value = formData.totalAptStops || '';
                    document.getElementById('firstBreak').value = formData.firstBreak || '';
                    document.getElementById('lunchBreak').value = formData.lunchBreak || '';
                    document.getElementById('secondBreak').value = formData.secondBreak || '';
                    document.getElementById('compareAmazonCheckbox').checked = formData.compareAmazon || false;
                    document.getElementById('amazonEndTime').value = formData.amazonEndTime || '17:00';
                    document.getElementById('hadRescueCheckbox').checked = formData.hadRescue || false;
                    document.getElementById('rescueTravelTime').value = formData.rescueTravelTime || '';
                    document.getElementById('rescueStopsAdded').value = formData.rescueStopsAdded || '';
                    document.getElementById('autoUpdateTime').checked = formData.autoUpdateTime !== false;
                    document.getElementById('autoClearAtMidnight').checked = formData.autoClearAtMidnight || false;
                    
                    // Show/hide fields based on loaded state
                    document.getElementById('amazonFields').style.display = formData.compareAmazon ? 'block' : 'none';
                    document.getElementById('rescueFields').style.display = formData.hadRescue ? 'block' : 'none';
                    
                } catch (e) {
                    console.error('Error loading form data:', e);
                }
            }
        }

        // NEW: Function to update current time to now
        function updateCurrentTimeToNow() {
            document.getElementById('currentTime').value = getCurrentTimeString();
            saveFormData();
        }

        // NEW: Auto-update time functionality
        let autoUpdateInterval;
        function setupAutoUpdate() {
            // Clear any existing interval
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }
            
            // Set up new interval if auto-update is enabled
            if (document.getElementById('autoUpdateTime').checked) {
                autoUpdateInterval = setInterval(() => {
                    document.getElementById('currentTime').value = getCurrentTimeString();
                }, 60000); // Update every minute
            }
        }

        // Settings persistence functions
        function saveSettings() {
            const settings = {
                theme: document.getElementById('themeSelector').value,
                darkMode: document.body.classList.contains('dark-mode'),
                fontSize: document.getElementById('fontSizeSlider').value,
                language: document.getElementById('languageSelector').value
            };
            localStorage.setItem('paceCalculatorSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('paceCalculatorSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    
                    setTimeout(() => {
                        if (settings.theme && document.getElementById('themeSelector')) {
                            document.getElementById('themeSelector').value = settings.theme;
                            applyTheme(settings.theme);
                        }
                        
                        if (settings.darkMode !== undefined) {
                            if (settings.darkMode) {
                                document.body.classList.add('dark-mode');
                                if (document.getElementById('darkModeToggle')) {
                                    document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
                                }
                            } else {
                                document.body.classList.remove('dark-mode');
                                if (document.getElementById('darkModeToggle')) {
                                    document.getElementById('darkModeToggle').textContent = 'üåô';
                                }
                            }
                        }
                        
                        if (settings.fontSize && document.getElementById('fontSizeSlider')) {
                            document.getElementById('fontSizeSlider').value = settings.fontSize;
                            document.documentElement.style.setProperty('--font-size', settings.fontSize + 'px');
                        }
                        
                        if (settings.language && document.getElementById('languageSelector')) {
                            document.getElementById('languageSelector').value = settings.language;
                            setLanguage(settings.language);
                        }
                    }, 10);
                } catch (e) {
                    console.error('Error loading settings:', e);
                    localStorage.removeItem('paceCalculatorSettings');
                }
            }
        }

        function applyTheme(theme) {
            document.body.classList.remove('theme-blue', 'theme-purple', 'theme-green', 'theme-red', 'theme-teal', 'theme-pink', 'theme-yellow', 'theme-amazon');
            if (theme !== 'default') {
                document.body.classList.add('theme-' + theme);
            }
        }

        function resetSettings() {
            localStorage.removeItem('paceCalculatorSettings');
            localStorage.removeItem('paceCalculatorFormData');
            
            document.getElementById('themeSelector').value = 'default';
            applyTheme('default');
            
            document.body.classList.remove('dark-mode');
            document.getElementById('darkModeToggle').textContent = 'üåô';
            
            document.getElementById('fontSizeSlider').value = '16';
            document.documentElement.style.setProperty('--font-size', '16px');
            
            document.getElementById('languageSelector').value = 'en';
            setLanguage('en');
            
            // Reset form to defaults
            resetAllFields();
            
            saveSettings();
            
            alert('All settings and data have been reset to defaults.');
        }

        function resetAllFields() {
            document.getElementById('firstPackageTime').value = '10:00';
            updateCurrentTimeToNow();
            
            document.getElementById('completedStops').value = '';
            document.getElementById('completedAptStops').value = '';
            document.getElementById('totalStops').value = '';
            document.getElementById('totalAptStops').value = '';
            
            document.getElementById('firstBreak').value = '';
            document.getElementById('lunchBreak').value = '';
            document.getElementById('secondBreak').value = '';
            
            document.getElementById('compareAmazonCheckbox').checked = false;
            document.getElementById('amazonFields').style.display = 'none';
            document.getElementById('amazonEndTime').value = '17:00';
            
            document.getElementById('hadRescueCheckbox').checked = false;
            document.getElementById('rescueFields').style.display = 'none';
            document.getElementById('rescueTravelTime').value = '';
            document.getElementById('rescueStopsAdded').value = '';
            
            document.getElementById('autoUpdateTime').checked = true;
            document.getElementById('autoClearAtMidnight').checked = false;
            
            document.getElementById('resultsSection').style.display = 'none';
            
            // Re-setup auto-update
            setupAutoUpdate();
            
            // Save the reset state
            saveFormData();
            
            const currentLang = document.getElementById('languageSelector').value;
            const message = currentLang === 'es' ? 
                'Todos los campos han sido restablecidos.' : 
                'All fields have been reset.';
            alert(message);
        }

        function scrollToResults() {
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) {
                resultsSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start'
                });
            }
        }

        // NEW: Event listener for manual time changes
        function handleManualTimeChange() {
            // When user manually changes time, turn off auto-update
            document.getElementById('autoUpdateTime').checked = false;
            setupAutoUpdate(); // This will clear the interval since auto-update is now off
            saveFormData();
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Load settings and form data
            loadSettings();
            loadFormData();
            
            // Set up auto-update based on loaded preferences
            setupAutoUpdate();
            
            // Set up event listeners for form changes
            const formInputs = [
                'firstPackageTime', 'currentTime', 'completedStops', 'completedAptStops',
                'totalStops', 'totalAptStops', 'firstBreak', 'lunchBreak', 'secondBreak',
                'amazonEndTime', 'rescueTravelTime', 'rescueStopsAdded'
            ];
            
            formInputs.forEach(id => {
                document.getElementById(id).addEventListener('change', saveFormData);
            });
            
            // Special handling for current time - manual changes disable auto-update
            document.getElementById('currentTime').addEventListener('change', handleManualTimeChange);
            
            // Checkboxes
            document.getElementById('compareAmazonCheckbox').addEventListener('change', function() {
                document.getElementById('amazonFields').style.display = this.checked ? 'block' : 'none';
                saveFormData();
            });
            
            document.getElementById('hadRescueCheckbox').addEventListener('change', function() {
                document.getElementById('rescueFields').style.display = this.checked ? 'block' : 'none';
                saveFormData();
            });
            
            document.getElementById('autoUpdateTime').addEventListener('change', function() {
                setupAutoUpdate();
                saveFormData();
            });
            
            document.getElementById('autoClearAtMidnight').addEventListener('change', saveFormData);
            
            // Update Now button
            document.getElementById('updateNowButton').addEventListener('click', updateCurrentTimeToNow);
            
            // Existing event listeners
            document.getElementById('fontSizeSlider').addEventListener('input', function() {
                document.documentElement.style.setProperty('--font-size', this.value + 'px');
                saveSettings();
            });
            
            document.getElementById('languageSelector').addEventListener('change', function() {
                setLanguage(this.value);
                saveSettings();
            });
            
            document.getElementById('themeSelector').addEventListener('change', function() {
                applyTheme(this.value);
                saveSettings();
            });
            
            document.getElementById('darkModeToggle').addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                this.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
                saveSettings();
            });
            
            document.getElementById('resetFields').addEventListener('click', resetAllFields);
            
            document.getElementById('resetSettings').addEventListener('click', resetSettings);
            
            // Calculate button with FULL working calculations
            document.getElementById('calculateButton').addEventListener('click', function() {
                const firstPackageTime = document.getElementById('firstPackageTime').value;
                const currentTime = document.getElementById('currentTime').value;
                const totalStops = parseInt(document.getElementById('totalStops').value) || 0;
                const completedStops = parseInt(document.getElementById('completedStops').value) || 0;
                
                if (!firstPackageTime || !currentTime || totalStops === 0 || completedStops === 0) {
                    const currentLang = document.getElementById('languageSelector').value;
                    const message = currentLang === 'es' ? 
                        "Por favor, completa todos los campos requeridos" : 
                        "Please fill in all required fields";
                    alert(message);
                    return;
                }
                
                const currentLang = document.getElementById('languageSelector').value;
                const calculatingText = currentLang === 'es' ? 'Calculando...' : 'Calculating...';
                document.getElementById('resultsContent').innerHTML = `<p><span class="loading"></span>${calculatingText}</p>`;
                document.getElementById('resultsSection').style.display = 'block';
                
                setTimeout(() => {
                    scrollToResults();
                }, 100);
                
                setTimeout(() => {
                    const t = translations[currentLang];
                    
                    // Get all input values
                    const firstPackageTime = document.getElementById('firstPackageTime').value;
                    const currentTime = document.getElementById('currentTime').value;
                    const totalStops = parseInt(document.getElementById('totalStops').value) || 0;
                    const completedStops = parseInt(document.getElementById('completedStops').value) || 0;
                    const remainingStops = totalStops - completedStops;
                    
                    // Get break times
                    const firstBreak = parseInt(document.getElementById('firstBreak').value) || 0;
                    const lunchBreak = parseInt(document.getElementById('lunchBreak').value) || 0;
                    const secondBreak = parseInt(document.getElementById('secondBreak').value) || 0;
                    const totalBreakTime = firstBreak + lunchBreak + secondBreak;
                    
                    // Get rescue data
                    const hadRescue = document.getElementById('hadRescueCheckbox').checked;
                    const rescueTravelTime = parseInt(document.getElementById('rescueTravelTime').value) || 0;
                    const rescueStopsAdded = parseInt(document.getElementById('rescueStopsAdded').value) || 0;
                    
                    // Get Amazon data
                    const compareAmazon = document.getElementById('compareAmazonCheckbox').checked;
                    const amazonEndTime = document.getElementById('amazonEndTime').value;
                    
                    // CORRECTED CALCULATIONS
                    const startMinutes = timeStringToMinutes(firstPackageTime);
                    const currentMinutes = timeStringToMinutes(currentTime);
                    
                    // Calculate gross elapsed time (including breaks)
                    let grossElapsedMinutes = currentMinutes - startMinutes;
                    if (grossElapsedMinutes < 0) grossElapsedMinutes += 24 * 60;
                    
                    // Calculate net working time (excluding breaks)
                    const netWorkingMinutes = grossElapsedMinutes - totalBreakTime;
                    
                    // Calculate current working pace (stops per hour of actual work)
                    const workingPaceStopsPerHour = netWorkingMinutes > 0 ? (completedStops / netWorkingMinutes) * 60 : 0;
                    
                    // Check if route is completed
                    const isRouteCompleted = remainingStops <= 0;
                    
                    // Calculate time needed for remaining stops at current working pace
                    const minutesForRemainingStops = remainingStops > 0 ? (remainingStops / workingPaceStopsPerHour) * 60 : 0;
                    
                    // Projected finish = current time + time for remaining stops
                    let projectedFinishMinutes;
                    let actualFinishMinutes = currentMinutes;
                    
                    if (isRouteCompleted) {
                        projectedFinishMinutes = currentMinutes;
                    } else {
                        projectedFinishMinutes = currentMinutes + minutesForRemainingStops;
                    }
                    
                    const projectedFinish12h = minutesTo12hTimeString(projectedFinishMinutes);
                    const actualFinish12h = minutesTo12hTimeString(actualFinishMinutes);
                    
                    // Build results HTML
                    let resultsHTML = `
                        <div class="result-group">
                            <h3>${t['full-route']}</h3>
                    `;
                    
                    if (isRouteCompleted) {
                        resultsHTML += `
                            <div class="completed-route-indicator">
                                ${t['route-completed']}
                            </div>
                            <p><strong>${t['current-pace']}:</strong> 
                                <span class="result-value">${Math.round(workingPaceStopsPerHour)} ${t['stops-hour']}</span>
                            </p>
                            <p><strong>${t['total-breaks']}:</strong> 
                                <span class="result-value">${totalBreakTime} ${t['minutes']}</span>
                            </p>
                            <p><strong>${t['actual-finish']}:</strong> 
                                <span class="result-value">${actualFinish12h}</span>
                            </p>
                        `;
                    } else {
                        resultsHTML += `
                            <p><strong>${t['current-pace']}:</strong> 
                                <span class="result-value">${Math.round(workingPaceStopsPerHour)} ${t['stops-hour']}</span>
                            </p>
                            <p><strong>${t['total-breaks']}:</strong> 
                                <span class="result-value">${totalBreakTime} ${t['minutes']}</span>
                            </p>
                            <p><strong>${t['projected-finish']}:</strong> 
                                <span class="result-value">${projectedFinish12h}</span>
                            </p>
                        `;
                    }
                    
                    resultsHTML += `</div>`;
                    
                    // Add Amazon comparison if applicable
                    if (compareAmazon && amazonEndTime) {
                        const amazonEndMinutes = timeStringToMinutes(amazonEndTime);
                        const amazonEnd12h = time24hTo12h(amazonEndTime);
                        
                        // Amazon's expectation is based on working time only (no breaks)
                        let amazonTotalWorkingMinutes = amazonEndMinutes - startMinutes;
                        if (amazonTotalWorkingMinutes < 0) amazonTotalWorkingMinutes += 24 * 60;
                        
                        // Amazon's expected working pace
                        const amazonExpectedPace = amazonTotalWorkingMinutes > 0 ? (totalStops / amazonTotalWorkingMinutes) * 60 : 0;
                        
                        // Amazon's expected finish time with breaks added
                        const amazonWithBreaksMinutes = amazonEndMinutes + totalBreakTime;
                        const amazonWithBreaks12h = minutesTo12hTimeString(amazonWithBreaksMinutes);
                        
                        // Calculate time differences - compare our projected finish to Amazon's expected finish (with breaks)
                        const vsAmazonDiff = Math.round(projectedFinishMinutes - amazonWithBreaksMinutes);
                        
                        resultsHTML += `
                            <div class="comparison-group">
                                <h3>${t['amazon-comparison']}</h3>
                                <div class="amazon-combined">
                                    <strong>${t['amazon-base']}:</strong>
                                    <span class="amazon-combined-value">${amazonEnd12h} / ${Math.round(amazonExpectedPace)} ${t['stops-hour']}</span>
                                </div>
                                <div class="amazon-combined">
                                    <strong>${t['amazon-with-breaks']}:</strong>
                                    <span class="amazon-combined-value">${amazonWithBreaks12h}</span>
                                </div>
                                <div class="vs-amazon-container">
                                    <strong>${t['vs-amazon']}:</strong>
                                    <span class="comparison-value">${Math.abs(vsAmazonDiff)} ${t['minutes']} ${vsAmazonDiff < 0 ? t['time-ahead'] : t['time-behind']}</span>
                                </div>
                            </div>
                        `;
                    } else if (compareAmazon && !amazonEndTime) {
                        resultsHTML += `
                            <div class="amazon-warning">
                                ‚ö†Ô∏è ${t['amazon-time-required']}
                            </div>
                        `;
                    }
                    
                    // Add rescue impact section if applicable
                    if (hadRescue && rescueStopsAdded > 0) {
                        const rescuePace = workingPaceStopsPerHour;
                        const rescueStopsTime = rescueStopsAdded > 0 ? (rescueStopsAdded / rescuePace) * 60 : 0;
                        const totalRescueTime = rescueTravelTime + rescueStopsTime;
                        const rescueProjectedFinishMinutes = projectedFinishMinutes + totalRescueTime;
                        const rescueProjectedFinish12h = minutesTo12hTimeString(rescueProjectedFinishMinutes);
                        
                        resultsHTML += `
                            <div class="rescue-result-group">
                                <h3>${t['rescue-impact']}</h3>
                                <p><strong>${t['rescue-stops-added']}:</strong> 
                                    <span class="rescue-value">${rescueStopsAdded}</span>
                                </p>
                                <p><strong>${t['rescue-travel-time']}:</strong> 
                                    <span class="rescue-value">${rescueTravelTime} ${t['minutes']}</span>
                                </p>
                                <p><strong>${t['rescue-total-time']}:</strong> 
                                    <span class="rescue-value">${Math.round(totalRescueTime)} ${t['minutes']}</span>
                                </p>
                                <p><strong>${t['rescue-pace']}:</strong> 
                                    <span class="rescue-value">${Math.round(rescuePace)} ${t['stops-hour']}</span>
                                </p>
                                <p><strong>${t['rescue-projected-finish']}:</strong> 
                                    <span class="rescue-value">${rescueProjectedFinish12h}</span>
                                </p>
                            </div>
                        `;
                    }
                    
                    // Add status indicator
                    let statusClass = "status-low";
                    let statusText = "";
                    
                    if (compareAmazon && amazonEndTime) {
                        const amazonEndMinutes = timeStringToMinutes(amazonEndTime);
                        const amazonWithBreaksMinutes = amazonEndMinutes + totalBreakTime;
                        const vsAmazonDiff = Math.round(projectedFinishMinutes - amazonWithBreaksMinutes);
                        
                        if (isRouteCompleted) {
                            if (vsAmazonDiff < 0) {
                                statusClass = "status-low";
                                statusText = currentLang === 'es' ? 
                                    `¬°${t['finished-ahead']}! ${Math.abs(vsAmazonDiff)} ${t['minutes']} ${t['time-ahead']} de Amazon` : 
                                    `${t['finished-ahead']}! ${Math.abs(vsAmazonDiff)} ${t['minutes']} ${t['time-ahead']} Amazon`;
                            } else if (vsAmazonDiff > 0) {
                                statusClass = "status-medium";
                                statusText = currentLang === 'es' ? 
                                    `Completado - ${vsAmazonDiff} ${t['minutes']} ${t['time-behind']} de Amazon` : 
                                    `Completed - ${vsAmazonDiff} ${t['minutes']} ${t['time-behind']} Amazon`;
                            } else {
                                statusClass = "status-low";
                                statusText = currentLang === 'es' ? 
                                    `¬°${t['status-on-track']}! Completado exactamente seg√∫n lo esperado por Amazon` : 
                                    `${t['status-on-track']}! Completed exactly as expected by Amazon`;
                            }
                        } else {
                            if (vsAmazonDiff > 30) {
                                statusClass = "status-high";
                                statusText = currentLang === 'es' ? 
                                    `${t['status-need-speed']} - ${vsAmazonDiff} ${t['minutes']} ${t['time-behind']} de Amazon` : 
                                    `${t['status-need-speed']} - ${vsAmazonDiff} ${t['minutes']} ${t['time-behind']} Amazon`;
                            } else if (vsAmazonDiff > 10) {
                                statusClass = "status-medium";
                                statusText = currentLang === 'es' ? 
                                    `${t['status-a-little-behind']} - ${vsAmazonDiff} ${t['minutes']} ${t['time-behind']} de Amazon` : 
                                    `${t['status-a-little-behind']} - ${vsAmazonDiff} ${t['minutes']} ${t['time-behind']} Amazon`;
                            } else if (vsAmazonDiff < -10) {
                                statusClass = "status-low";
                                statusText = currentLang === 'es' ? 
                                    `${t['status-ahead']}! ${Math.abs(vsAmazonDiff)} ${t['minutes']} ${t['time-ahead']} de Amazon` : 
                                    `${t['status-ahead']}! ${Math.abs(vsAmazonDiff)} ${t['minutes']} ${t['time-ahead']} Amazon`;
                            } else {
                                statusClass = "status-low";
                                statusText = currentLang === 'es' ? 
                                    `¬°${t['status-on-track']}! Vas seg√∫n lo esperado por Amazon` : 
                                    `${t['status-on-track']}! Meeting Amazon's expectations`;
                            }
                        }
                    } else {
                        if (isRouteCompleted) {
                            statusText = currentLang === 'es' ? 
                                '¬°Ruta completada! Buen trabajo.' : 
                                'Route completed! Good job.';
                        } else {
                            statusText = currentLang === 'es' ? 
                                '¬°Buen ritmo! Contin√∫a as√≠' : 
                                'Good pace! Keep it up';
                        }
                    }
                    
                    resultsHTML += `
                        <div class="status-indicator ${statusClass}">
                            <strong>${currentLang === 'es' ? 'Recomendaci√≥n' : 'Recommendation'}:</strong><br>
                            ${statusText}
                        </div>
                    `;
                    
                    document.getElementById('resultsContent').innerHTML = resultsHTML;
                    
                    setTimeout(() => {
                        scrollToResults();
                    }, 100);
                }, 500);
            });
        });
    </script>
</body>
</html>
